#include <stdint.h>
#include <string.h>
#include <stdlib.h>

#include "hmac_sha256.h"
#include "sha256.h"
#include "util.h"

const uint8_t ipad[64] = {0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36};
const uint8_t opad[64] = {0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c};

void adjust_key(const uint8_t* const key, const uint32_t keylen, uint8_t* const out) {
	memset(out, 0, 64);
	if(keylen <= 64) {
		memcpy(out, key, keylen);
	} else {
		hash_sha256(key, keylen, out);
	}
}

void hmac_sha256(const uint8_t* const key, const uint32_t keylen, const uint8_t* const message, uint32_t len, uint8_t* const out) {
	uint8_t adjkey[64];
	adjust_key(key, keylen, adjkey);
	
	uint8_t* inner_hash_buf = (uint8_t*) malloc(len + 64); // this could be any size
	xor_bytes(adjkey, ipad, 64, inner_hash_buf);
	memcpy(inner_hash_buf + 64, message, len);
	
	uint8_t outer_hash_buf[96]; // this is just a 64 byte key plus a 32 byte hash
	xor_bytes(adjkey, opad, 64, outer_hash_buf);
	hash_sha256(inner_hash_buf, len + 64, outer_hash_buf + 64);
	
	hash_sha256(outer_hash_buf, 96, out);
}
